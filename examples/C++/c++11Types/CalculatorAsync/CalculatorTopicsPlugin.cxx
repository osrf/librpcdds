/*************************************************************************
 * Copyright (c) 2012 eProsima. All rights reserved.
 *
 * This generated file is licensed to you under the terms described in the
 * FASTRPC_LICENSE file included in this FASTRPC distribution.
 *
 *************************************************************************
 * 
 * @file CalculatorTopicsPlugin.cpp
 * TODO This header file contains the declaration of topics generated using operations in the IDL file.
 *
 * This file was generated by the tool rpcddsgen.
 */

#include "CalculatorTopicsPlugin.h"
#include "rpcdds/protocols/dds/MessageHeaderPlugin.h"
#include "rpcdds/exceptions/BadParamException.h"

#include "fastcdr/Cdr.h"
#include "fastcdr/exceptions/BadParamException.h"
#include "fastcdr/exceptions/NotEnoughMemoryException.h"

// Request operations
DDS_TypeCode* CalculatorPlugin::additionRequestPlugin::get_typecode()
{
    //printf("=> Calculator_additionRequestPlugin::get_typecode\n");
    static bool is_initialized = false;



    static DDS_TypeCode_Member Calculator_additionRequest_g_tc_members[2] =
    {
                {
                    (char *)"value1",
                    {
                        0,
                        DDS_BOOLEAN_FALSE,
                        -1,
                        NULL
                    },
                    0,
                    0,
                    0,
                    NULL,
                    DDS_BOOLEAN_FALSE,
                    DDS_PRIVATE_MEMBER,
                    0,
                    NULL
                },
                {
                    (char *)"value2",
                    {
                        0,
                        DDS_BOOLEAN_FALSE,
                        -1,
                        NULL
                    },
                    0,
                    0,
                    0,
                    NULL,
                    DDS_BOOLEAN_FALSE,
                    DDS_PRIVATE_MEMBER,
                    0,
                    NULL
                }
    };

    static DDS_TypeCode Calculator_additionRequest_g_tc =
    {{
         DDS_TK_STRUCT,
         DDS_BOOLEAN_FALSE,
         -1,
         (char*)"Calculator_additionRequest",
         NULL,
         0,
         0,
         NULL,
         2,
         Calculator_additionRequest_g_tc_members,
         DDS_VM_NONE
    }};
    
    if(!is_initialized)
    {
        Calculator_additionRequest_g_tc_members[1 - 1]._representation._typeCode = (RTICdrTypeCode*)&DDS_g_tc_long;
        Calculator_additionRequest_g_tc_members[2 - 1]._representation._typeCode = (RTICdrTypeCode*)&DDS_g_tc_long;
        is_initialized = true;
    }

    return &Calculator_additionRequest_g_tc;
}

// Reply operations

DDS_TypeCode* CalculatorPlugin::additionReplyPlugin::get_typecode()
{
    //printf("=> CalculatorPlugin::additionReplyPlugin::get_typecode\n");
    static bool is_initialized = false;


    static DDS_TypeCode_Member Calculator_additionReply_g_tc_members[1] =
    {
                {
                    (char *)"addition_ret",
                    {
                        0,
                        DDS_BOOLEAN_FALSE,
                        -1,
                        NULL
                    },
                    0,
                    0,
                    0,
                    NULL,
                    DDS_BOOLEAN_FALSE,
                    DDS_PRIVATE_MEMBER,
                    0,
                    NULL
                }
    };

    static DDS_TypeCode Calculator_additionReply_g_tc =
    {{
         DDS_TK_STRUCT,
         DDS_BOOLEAN_FALSE,
         -1,
         (char*)"Calculator_additionReply",
         NULL,
         0,
         0,
         NULL,
         1,
         Calculator_additionReply_g_tc_members,
         DDS_VM_NONE
    }};
    
    if(!is_initialized)
    {
        Calculator_additionReply_g_tc_members[1 - 1]._representation._typeCode = (RTICdrTypeCode*)&DDS_g_tc_long;

        is_initialized = true;
    }

    return &Calculator_additionReply_g_tc;
}

// Request operations
DDS_TypeCode* CalculatorPlugin::subtractionRequestPlugin::get_typecode()
{
    //printf("=> Calculator_subtractionRequestPlugin::get_typecode\n");
    static bool is_initialized = false;



    static DDS_TypeCode_Member Calculator_subtractionRequest_g_tc_members[2] =
    {
                {
                    (char *)"value1",
                    {
                        0,
                        DDS_BOOLEAN_FALSE,
                        -1,
                        NULL
                    },
                    0,
                    0,
                    0,
                    NULL,
                    DDS_BOOLEAN_FALSE,
                    DDS_PRIVATE_MEMBER,
                    0,
                    NULL
                },
                {
                    (char *)"value2",
                    {
                        0,
                        DDS_BOOLEAN_FALSE,
                        -1,
                        NULL
                    },
                    0,
                    0,
                    0,
                    NULL,
                    DDS_BOOLEAN_FALSE,
                    DDS_PRIVATE_MEMBER,
                    0,
                    NULL
                }
    };

    static DDS_TypeCode Calculator_subtractionRequest_g_tc =
    {{
         DDS_TK_STRUCT,
         DDS_BOOLEAN_FALSE,
         -1,
         (char*)"Calculator_subtractionRequest",
         NULL,
         0,
         0,
         NULL,
         2,
         Calculator_subtractionRequest_g_tc_members,
         DDS_VM_NONE
    }};
    
    if(!is_initialized)
    {
        Calculator_subtractionRequest_g_tc_members[1 - 1]._representation._typeCode = (RTICdrTypeCode*)&DDS_g_tc_long;
        Calculator_subtractionRequest_g_tc_members[2 - 1]._representation._typeCode = (RTICdrTypeCode*)&DDS_g_tc_long;
        is_initialized = true;
    }

    return &Calculator_subtractionRequest_g_tc;
}

// Reply operations

DDS_TypeCode* CalculatorPlugin::subtractionReplyPlugin::get_typecode()
{
    //printf("=> CalculatorPlugin::subtractionReplyPlugin::get_typecode\n");
    static bool is_initialized = false;


    static DDS_TypeCode_Member Calculator_subtractionReply_g_tc_members[1] =
    {
                {
                    (char *)"subtraction_ret",
                    {
                        0,
                        DDS_BOOLEAN_FALSE,
                        -1,
                        NULL
                    },
                    0,
                    0,
                    0,
                    NULL,
                    DDS_BOOLEAN_FALSE,
                    DDS_PRIVATE_MEMBER,
                    0,
                    NULL
                }
    };

    static DDS_TypeCode Calculator_subtractionReply_g_tc =
    {{
         DDS_TK_STRUCT,
         DDS_BOOLEAN_FALSE,
         -1,
         (char*)"Calculator_subtractionReply",
         NULL,
         0,
         0,
         NULL,
         1,
         Calculator_subtractionReply_g_tc_members,
         DDS_VM_NONE
    }};
    
    if(!is_initialized)
    {
        Calculator_subtractionReply_g_tc_members[1 - 1]._representation._typeCode = (RTICdrTypeCode*)&DDS_g_tc_long;

        is_initialized = true;
    }

    return &Calculator_subtractionReply_g_tc;
}


// Request interface
const char *CalculatorRequestPlugin::m_typename = "CalculatorRequest";

const char* CalculatorRequestPlugin::get_typename()
{
    //printf("=> CalculatorRequestPlugin::get_typename\n");
    return m_typename;
}

CalculatorRequest*
CalculatorRequestPlugin::create_data(void)
{
    //printf("=> CalculatorRequestPlugin::create_data\n");
    CalculatorRequest *request = new CalculatorRequest();
    return request;
}

void 
CalculatorRequestPlugin::destroy_data(
    CalculatorRequest *sample)
{
    //printf("=> CalculatorRequestPlugin::destroy_data\n");
    if(sample != NULL)
        delete sample;
}

void 
CalculatorRequestPlugin::copy_data(
    CalculatorRequest *dst,
    const CalculatorRequest *src)
{
    //printf("=> CalculatorRequestPlugin::copy_data\n");
    *dst = *src;
}

unsigned int 
CalculatorRequestPlugin::get_serialized_sample_max_size(
    PRESTypePluginEndpointData endpoint_data,
    RTIBool include_encapsulation,
    RTIEncapsulationId encapsulation_id,
    unsigned int current_alignment)
{
    //printf("=> CalculatorRequestPlugin::get_serialized_sample_max_size\n");
    unsigned int initial_alignment = current_alignment;

    unsigned int encapsulation_size = current_alignment;

    if (include_encapsulation) {

        if (!RTICdrEncapsulation_validEncapsulationId(encapsulation_id)) {
            return 1;
        }

        RTICdrStream_getEncapsulationSize(encapsulation_size);
        encapsulation_size -= current_alignment;
        current_alignment = 0;
        initial_alignment = 0;

    }

    current_alignment += CalculatorRequest::getMaxCdrSerializedSize(current_alignment);

    if (include_encapsulation) {
        current_alignment += encapsulation_size;
    } 

    //printf("Max ser size: %u\n", current_alignment - initial_alignment);
    return current_alignment - initial_alignment;
}

unsigned int
CalculatorRequestPlugin::get_serialized_sample_size(
    PRESTypePluginEndpointData endpoint_data,
    RTIBool include_encapsulation,
    RTIEncapsulationId encapsulation_id,
    unsigned int current_alignment,
    const CalculatorRequest * sample)
{
    //printf("=> CalculatorRequestPlugin::get_serialized_sample_size\n");
    /* TODO
    unsigned int initial_alignment = current_alignment;

    unsigned int encapsulation_size = current_alignment;

    if (include_encapsulation) {

        if (!RTICdrEncapsulation_validEncapsulationId(encapsulation_id)) {
            return 1;
        }

        RTICdrStream_getEncapsulationSize(encapsulation_size);
        encapsulation_size -= current_alignment;
        current_alignment = 0;
        initial_alignment = 0;

    }


    current_alignment += RequestHeaderPlugin::get_serialized_sample_size(
        endpoint_data,RTI_FALSE, encapsulation_id, 
        current_alignment, &sample->header);
            

    current_alignment += RTICdrType_getOctetMaxSizeSerialized(
        current_alignment);
            

    current_alignment += RTICdrType_getOctetMaxSizeSerialized(
        current_alignment);
            

    if (include_encapsulation) {
        current_alignment += encapsulation_size;
    }

    return current_alignment - initial_alignment;
    */

    return sample->getSerializedSize(current_alignment);
}

unsigned int 
CalculatorRequestPlugin::get_serialized_sample_min_size(
    PRESTypePluginEndpointData endpoint_data,
    RTIBool include_encapsulation,
    RTIEncapsulationId encapsulation_id,
    unsigned int current_alignment)
{
    //printf("=> CalculatorRequestPlugin::get_serialized_sample_min_size\n");
    // TODO
    return 0;
}

PRESTypePluginParticipantData 
CalculatorRequestPlugin::on_participant_attached(
    void *registration_data, 
    const struct PRESTypePluginParticipantInfo *participant_info,
    RTIBool top_level_registration, 
    void *container_plugin_context,
    RTICdrTypeCode *typeCode)
{
    //printf("=> CalculatorRequestPlugin::on_participant_attached\n");
    return PRESTypePluginDefaultParticipantData_new(participant_info);
}

void
CalculatorRequestPlugin::on_participant_detached(
    PRESTypePluginParticipantData participant_data)
{
    //printf("=> CalculatorRequestPlugin::on_participant_detached\n");
    PRESTypePluginDefaultParticipantData_delete(participant_data);
}

PRESTypePluginEndpointData 
CalculatorRequestPlugin::on_endpoint_attached(
    PRESTypePluginParticipantData participant_data,
    const struct PRESTypePluginEndpointInfo *endpoint_info,
    RTIBool top_level_registration, 
    void *container_plugin_context)
{
    //printf("=> CalculatorRequestPlugin::on_endpoint_attached\n");
    PRESTypePluginEndpointData epd = NULL;
    unsigned int serializedSampleMaxSize;

    epd = PRESTypePluginDefaultEndpointData_new(
            participant_data,
            endpoint_info,
            (PRESTypePluginDefaultEndpointDataCreateSampleFunction)
            CalculatorRequestPlugin::create_data,
            (PRESTypePluginDefaultEndpointDataDestroySampleFunction)
            CalculatorRequestPlugin::destroy_data,
            NULL, NULL);

    if(epd != NULL)
    {
        if(endpoint_info->endpointKind == PRES_TYPEPLUGIN_ENDPOINT_WRITER)
        {
            serializedSampleMaxSize = CalculatorRequestPlugin::get_serialized_sample_max_size(
                    epd, RTI_FALSE, RTI_CDR_ENCAPSULATION_ID_CDR_BE, 0);

            PRESTypePluginDefaultEndpointData_setMaxSizeSerializedSample(epd, serializedSampleMaxSize);

            if(PRESTypePluginDefaultEndpointData_createWriterPool(
                        epd,
                        endpoint_info,
                        (PRESTypePluginGetSerializedSampleMaxSizeFunction)
                        CalculatorRequestPlugin::get_serialized_sample_max_size, epd,
                        (PRESTypePluginGetSerializedSampleSizeFunction)
                        CalculatorRequestPlugin::get_serialized_sample_size,
                        epd) == RTI_FALSE)
            {
                PRESTypePluginDefaultEndpointData_delete(epd);
                epd = NULL;
            }
        }
    }

    return epd;    
}

void 
CalculatorRequestPlugin::on_endpoint_detached(
    PRESTypePluginEndpointData endpoint_data)
{  
    //printf("=> CalculatorRequestPlugin::on_endpoint_detached\n");
    PRESTypePluginDefaultEndpointData_delete(endpoint_data);
}

RTIBool 
CalculatorRequestPlugin::copy_sample(
    PRESTypePluginEndpointData endpoint_data,
    CalculatorRequest *dst,
    const CalculatorRequest *src)
{
    //printf("=> CalculatorRequestPlugin::copy_sample\n");
    // TODO exception?
    *dst = *src;
    CalculatorRequestPlugin::copy_data(dst, src);
    return RTI_TRUE;
}

RTIBool 
CalculatorRequestPlugin::serialize(
    PRESTypePluginEndpointData endpoint_data,
    const CalculatorRequest *sample, 
    struct RTICdrStream *stream,    
    RTIBool serialize_encapsulation,
    RTIEncapsulationId encapsulation_id,
    RTIBool serialize_sample, 
    void *endpoint_plugin_qos)
{
    //printf("=> CalculatorRequestPlugin::serialize\n");
    eprosima::fastcdr::FastBuffer buffer(stream->_buffer, stream->_bufferLength);
    eprosima::fastcdr::Cdr scdr(buffer, (eprosima::fastcdr::Cdr::Endianness)stream->_endian, eprosima::fastcdr::Cdr::DDS_CDR);
    scdr.moveAlignmentForward(stream->_relativeBuffer - stream->_buffer);
    scdr.jump(stream->_currentPosition - stream->_buffer);

    if(serialize_encapsulation)
    {
        scdr.changeEndianness((eprosima::fastcdr::Cdr::Endianness)(encapsulation_id & 0x1));
        scdr.serialize_encapsulation();
        scdr.resetAlignment();
    }

    if(serialize_sample)
    {
        try
        {
            scdr << *sample;
        }
        catch(eprosima::rpc::exception::BadParamException ex)
        {
            //printf("ERROR<eprosima::rpc::exception::BadParamException>: %s\n", ex.what());
            return RTI_FALSE;
        }
        catch(eprosima::fastcdr::exception::BadParamException ex)
        {
            //printf("ERROR<eprosima::fastcdr::exception::BadParamException>: %s\n", ex.what());
            return RTI_FALSE;
        }
        catch(eprosima::fastcdr::exception::NotEnoughMemoryException ex)
        {
            //printf("ERROR<eprosima::fastcdr::exception::NotEnoughMemoryException>: %s\n", ex.what());
            return RTI_FALSE;
        }
    }

    stream->_currentPosition = scdr.getCurrentPosition();

    return RTI_TRUE;
}

RTIBool 
CalculatorRequestPlugin::deserialize(
    PRESTypePluginEndpointData endpoint_data,
    CalculatorRequest **sample,
    RTIBool * drop_sample,
    struct RTICdrStream *stream,   
    RTIBool deserialize_encapsulation,
    RTIBool deserialize_sample, 
    void *endpoint_plugin_qos)
{
    //printf("=> CalculatorRequestPlugin::deserialize\n");
    CalculatorRequest *_sample = *sample;
    eprosima::fastcdr::FastBuffer buffer(stream->_buffer, stream->_bufferLength);
    eprosima::fastcdr::Cdr dcdr(buffer, (eprosima::fastcdr::Cdr::Endianness)stream->_endian, eprosima::fastcdr::Cdr::DDS_CDR);
    dcdr.moveAlignmentForward(stream->_relativeBuffer - stream->_buffer);
    dcdr.jump(stream->_currentPosition - stream->_buffer);

    if(deserialize_encapsulation)
    {
        dcdr.read_encapsulation();
        dcdr.resetAlignment();
    }

    if(deserialize_sample)
    {
        dcdr >> *_sample;
    }

    stream->_currentPosition = dcdr.getCurrentPosition();

    return RTI_TRUE;
}

PRESTypePluginKeyKind 
CalculatorRequestPlugin::get_key_kind(void)
{
    //printf("=> CalculatorRequestPlugin::get_key_kind\n");
    return PRES_TYPEPLUGIN_NO_KEY;
}

DDS_TypeCode* CalculatorRequest_unionPlugin::get_typecode()
{
    static bool is_initialized = false;

    static DDS_TypeCode_Member CalculatorRequest_union_g_tc_members[2] =
    {
                {
                    (char *)"addition",
                    {
                        0,
                        DDS_BOOLEAN_FALSE,
                        -1,
                        NULL
                    },
                    0,
                    1,
                    1,
                    NULL,
                    DDS_BOOLEAN_FALSE,
                    DDS_PRIVATE_MEMBER,
                    0,
                    NULL
                },
                {
                    (char *)"subtraction",
                    {
                        0,
                        DDS_BOOLEAN_FALSE,
                        -1,
                        NULL
                    },
                    0,
                    1,
                    2,
                    NULL,
                    DDS_BOOLEAN_FALSE,
                    DDS_PRIVATE_MEMBER,
                    0,
                    NULL
                }
    };

    static DDS_TypeCode CalculatorRequest_union_g_tc =
    {{
         DDS_TK_UNION,
         DDS_BOOLEAN_FALSE,
         -1,
         (char*)"CalculatorRequest_union",
         NULL,
         0,
         0,
         NULL,
         2,
         CalculatorRequest_union_g_tc_members,
         DDS_VM_NONE
    }};
    
    if(!is_initialized)
    {
        CalculatorRequest_union_g_tc_members[1 - 1]._representation._typeCode = (RTICdrTypeCode*)CalculatorPlugin::additionRequestPlugin::get_typecode();
        CalculatorRequest_union_g_tc_members[2 - 1]._representation._typeCode = (RTICdrTypeCode*)CalculatorPlugin::subtractionRequestPlugin::get_typecode();

        CalculatorRequest_union_g_tc._data._typeCode = (RTICdrTypeCode*)&DDS_g_tc_long;

        is_initialized = true;
    }

    return &CalculatorRequest_union_g_tc;
}

DDS_TypeCode* CalculatorRequestPlugin::get_typecode()
{
    //printf("=> CalculatorRequestPlugin::get_typecode\n");
    static bool is_initialized = false;

    static DDS_TypeCode_Member CalculatorRequest_g_tc_members[2] =
    {
        // TODO Add header.
        {
            (char *)"_header",
            {
                0,
                DDS_BOOLEAN_FALSE,
                -1,
                NULL
            },
            0,
            0,
            0,
            NULL,
            DDS_BOOLEAN_FALSE,
            DDS_PRIVATE_MEMBER,
            0,
            NULL
        },
        {
            (char *)"unio",
            {
                0,
                DDS_BOOLEAN_FALSE,
                -1,
                NULL
            },
            0,
            0,
            0,
            NULL,
            DDS_BOOLEAN_FALSE,
            DDS_PRIVATE_MEMBER,
            0,
            NULL
        }
    };

    static DDS_TypeCode CalculatorRequest_g_tc =
    {{
         DDS_TK_STRUCT,
         DDS_BOOLEAN_FALSE,
         -1,
         (char*)m_typename,
         NULL,
         0,
         0,
         NULL,
         2,
         CalculatorRequest_g_tc_members,
         DDS_VM_NONE
    }};
    
    if(!is_initialized)
    {
        CalculatorRequest_g_tc_members[0]._representation._typeCode = (RTICdrTypeCode *)eprosima::rpc::protocol::dds::RequestHeaderPlugin::get_typecode();
        CalculatorRequest_g_tc_members[1]._representation._typeCode = (RTICdrTypeCode *)CalculatorRequest_unionPlugin::get_typecode();
        is_initialized = true;
    }

    return &CalculatorRequest_g_tc;
}

struct PRESTypePlugin *CalculatorRequestPlugin::new_plugin(void)
{
    //printf("=> CalculatorRequestPlugin::new_plugin\n");
    struct PRESTypePlugin *plugin = NULL;
    const struct PRESTypePluginVersion PLUGIN_VERSION = PRES_TYPE_PLUGIN_VERSION_2_0;

    RTIOsapiHeap_allocateStructure(&plugin, struct PRESTypePlugin);

    if (plugin != NULL)
    {
        plugin->version = PLUGIN_VERSION;

        /* set up parent's function pointers */
        plugin->onParticipantAttached =
            (PRESTypePluginOnParticipantAttachedCallback)
            CalculatorRequestPlugin::on_participant_attached;
        plugin->onParticipantDetached =
            (PRESTypePluginOnParticipantDetachedCallback)
            CalculatorRequestPlugin::on_participant_detached;
        plugin->onEndpointAttached =
            (PRESTypePluginOnEndpointAttachedCallback)
            CalculatorRequestPlugin::on_endpoint_attached;
        plugin->onEndpointDetached =
            (PRESTypePluginOnEndpointDetachedCallback)
            CalculatorRequestPlugin::on_endpoint_detached;

        plugin->copySampleFnc =
            (PRESTypePluginCopySampleFunction)
            CalculatorRequestPlugin::copy_sample;
        plugin->createSampleFnc =
            (PRESTypePluginCreateSampleFunction)
            PRESTypePluginDefaultEndpointData_createSample;
        plugin->destroySampleFnc =
            (PRESTypePluginDestroySampleFunction)
            PRESTypePluginDefaultEndpointData_deleteSample;

        plugin->serializeFnc =
            (PRESTypePluginSerializeFunction)
            CalculatorRequestPlugin::serialize;
        plugin->deserializeFnc =
            (PRESTypePluginDeserializeFunction)
            CalculatorRequestPlugin::deserialize;
        plugin->getSerializedSampleMaxSizeFnc =
            (PRESTypePluginGetSerializedSampleMaxSizeFunction)
            CalculatorRequestPlugin::get_serialized_sample_max_size;
        plugin->getSerializedSampleMinSizeFnc =
            (PRESTypePluginGetSerializedSampleMinSizeFunction)
            CalculatorRequestPlugin::get_serialized_sample_min_size;


        plugin->getSampleFnc =
            (PRESTypePluginGetSampleFunction)
            PRESTypePluginDefaultEndpointData_getSample;

        plugin->returnSampleFnc =
            (PRESTypePluginReturnSampleFunction)
            PRESTypePluginDefaultEndpointData_returnSample;

        plugin->getKeyKindFnc =
            (PRESTypePluginGetKeyKindFunction)
            CalculatorRequestPlugin::get_key_kind;


        /* These functions are only used for keyed types. As this is not a keyed
           type they are all set to NULL
         */
        plugin->serializeKeyFnc = NULL;
        plugin->deserializeKeyFnc = NULL;
        plugin->getKeyFnc = NULL;
        plugin->returnKeyFnc = NULL;
        plugin->instanceToKeyFnc = NULL;
        plugin->keyToInstanceFnc = NULL;
        plugin->getSerializedKeyMaxSizeFnc = NULL;
        plugin->instanceToKeyHashFnc = NULL;
        plugin->serializedSampleToKeyHashFnc = NULL;
        plugin->serializedKeyToKeyHashFnc = NULL;

        plugin->typeCode =  (struct RTICdrTypeCode *)CalculatorRequestPlugin::get_typecode();

        plugin->languageKind = PRES_TYPEPLUGIN_DDS_TYPE; 

        /* Serialized buffer */
        plugin->getBuffer = 
            (PRESTypePluginGetBufferFunction)
            PRESTypePluginDefaultEndpointData_getBuffer;
        plugin->returnBuffer = 
            (PRESTypePluginReturnBufferFunction)
            PRESTypePluginDefaultEndpointData_returnBuffer;
        plugin->getSerializedSampleSizeFnc =
            (PRESTypePluginGetSerializedSampleSizeFunction)
            CalculatorRequestPlugin::get_serialized_sample_size;

        plugin->endpointTypeName = m_typename;

        return plugin;
    }

    return NULL;
}

void
CalculatorRequestPlugin::delete_plugin(struct PRESTypePlugin *plugin)
{
    //printf("=> CalculatorRequestPlugin::delete_plugin\n");
    RTIOsapiHeap_freeStructure(plugin);
}

bool CalculatorRequestPlugin::register_type(DDSDomainParticipant *participant, const char *type_name)
{
    //printf("=> CalculatorRequestPlugin::register_type\n");
    bool returnedValue = false;
    struct PRESTypePlugin *typeDDSPlugin = NULL;
    static DDSTypeSupport *typePlugin = NULL;

    if(participant != NULL)
    {
        typeDDSPlugin = CalculatorRequestPlugin::new_plugin();

        if(typeDDSPlugin != NULL)
        {
            if(typePlugin == NULL)
            {
                typePlugin = new CalculatorRequestPlugin();
            }

            typeDDSPlugin->_userBuffer = (PRESWord*)typePlugin;

            if(DDS_DomainParticipant_register_type(participant->get_c_domain_participantI(), type_name, typeDDSPlugin, NULL) == DDS_RETCODE_OK)
                returnedValue = true;

            CalculatorRequestPlugin::delete_plugin(typeDDSPlugin);
        }
    }

    return returnedValue;
}

DDSDataReader* CalculatorRequestPlugin::create_datareaderI(DDSDataReader* dataReader)
{
    return new CalculatorRequestDataReader(dataReader);
}

DDS_ReturnCode_t CalculatorRequestPlugin::destroy_datareaderI(DDSDataReader* dataReader)
{
    delete (CalculatorRequestDataReader*)dataReader;
    return DDS_RETCODE_OK;
}

DDSDataWriter* CalculatorRequestPlugin::create_datawriterI(DDSDataWriter* dataWriter)
{
    return new CalculatorRequestDataWriter(dataWriter);
}

DDS_ReturnCode_t CalculatorRequestPlugin::destroy_datawriterI(DDSDataWriter* dataWriter)
{
    delete (CalculatorRequestDataWriter*)dataWriter;
    return DDS_RETCODE_OK;
}

// Reply interfaces
const char *CalculatorReplyPlugin::m_typename = "CalculatorReply";

const char* CalculatorReplyPlugin::get_typename()
{
    //printf("=> CalculatorReplyPlugin::get_typename\n");
    return m_typename;
}

void 
CalculatorReplyPlugin::copy_data(
    CalculatorReply *dst,
    const CalculatorReply *src)
{
    //printf("=> CalculatorReplyPlugin::copy_data\n");
    *dst = *src;
}

CalculatorReply*
CalculatorReplyPlugin::create_data(void)
{
    //printf("=> CalculatorReplyPlugin::create_data\n");
    CalculatorReply *reply = new CalculatorReply();
    return reply;
}

void 
CalculatorReplyPlugin::destroy_data(
    CalculatorReply *sample)
{
    //printf("=> CalculatorReplyPlugin::destroy_data\n");
    if(sample != NULL)
        delete sample;
}

unsigned int 
CalculatorReplyPlugin::get_serialized_sample_max_size(
    PRESTypePluginEndpointData endpoint_data,
    RTIBool include_encapsulation,
    RTIEncapsulationId encapsulation_id,
    unsigned int current_alignment)
{
    //printf("=> CalculatorReplyPlugin::get_serialized_sample_max_size\n");
    unsigned int initial_alignment = current_alignment;

    unsigned int encapsulation_size = current_alignment;

    if (include_encapsulation) {

        if (!RTICdrEncapsulation_validEncapsulationId(encapsulation_id)) {
            return 1;
        }

        RTICdrStream_getEncapsulationSize(encapsulation_size);
        encapsulation_size -= current_alignment;
        current_alignment = 0;
        initial_alignment = 0;

    }


    current_alignment += CalculatorReply::getMaxCdrSerializedSize(current_alignment);

    if (include_encapsulation) {
        current_alignment += encapsulation_size;
    } 

    //printf("Max ser size: %u\n", current_alignment - initial_alignment);
    return current_alignment - initial_alignment;
}

unsigned int
CalculatorReplyPlugin::get_serialized_sample_size(
    PRESTypePluginEndpointData endpoint_data,
    RTIBool include_encapsulation,
    RTIEncapsulationId encapsulation_id,
    unsigned int current_alignment,
    const CalculatorReply * sample)
{
    //printf("=> CalculatorReplyPlugin::get_serialized_sample_size\n");
    /* TODO
    unsigned int initial_alignment = current_alignment;

    unsigned int encapsulation_size = current_alignment;

    if (include_encapsulation) {

        if (!RTICdrEncapsulation_validEncapsulationId(encapsulation_id)) {
            return 1;
        }

        RTICdrStream_getEncapsulationSize(encapsulation_size);
        encapsulation_size -= current_alignment;
        current_alignment = 0;
        initial_alignment = 0;

    }


    current_alignment += RequestHeaderPlugin::get_serialized_sample_size(
        endpoint_data,RTI_FALSE, encapsulation_id, 
        current_alignment, &sample->header);
            

    current_alignment += RTICdrType_getOctetMaxSizeSerialized(
        current_alignment);
            

    current_alignment += RTICdrType_getOctetMaxSizeSerialized(
        current_alignment);
            

    if (include_encapsulation) {
        current_alignment += encapsulation_size;
    }

    return current_alignment - initial_alignment;
    */

    return sample->getSerializedSize(current_alignment);
}

unsigned int 
CalculatorReplyPlugin::get_serialized_sample_min_size(
    PRESTypePluginEndpointData endpoint_data,
    RTIBool include_encapsulation,
    RTIEncapsulationId encapsulation_id,
    unsigned int current_alignment)
{
    //printf("=> CalculatorReplyPlugin::get_serialized_sample_min_size\n");
    // TODO
    return 0;
}

PRESTypePluginParticipantData 
CalculatorReplyPlugin::on_participant_attached(
    void *registration_data, 
    const struct PRESTypePluginParticipantInfo *participant_info,
    RTIBool top_level_registration, 
    void *container_plugin_context,
    RTICdrTypeCode *typeCode)
{
    //printf("=> CalculatorReplyPlugin::on_participant_attached\n");
    return PRESTypePluginDefaultParticipantData_new(participant_info);
}

void
CalculatorReplyPlugin::on_participant_detached(
    PRESTypePluginParticipantData participant_data)
{
    //printf("=> CalculatorReplyPlugin::on_participant_detached\n");
    PRESTypePluginDefaultParticipantData_delete(participant_data);
}

PRESTypePluginEndpointData 
CalculatorReplyPlugin::on_endpoint_attached(
    PRESTypePluginParticipantData participant_data,
    const struct PRESTypePluginEndpointInfo *endpoint_info,
    RTIBool top_level_registration, 
    void *container_plugin_context)
{
    //printf("=> CalculatorReplyPlugin::on_endpoint_attached\n");
    PRESTypePluginEndpointData epd = NULL;
    unsigned int serializedSampleMaxSize;

    epd = PRESTypePluginDefaultEndpointData_new(
            participant_data,
            endpoint_info,
            (PRESTypePluginDefaultEndpointDataCreateSampleFunction)
            CalculatorReplyPlugin::create_data,
            (PRESTypePluginDefaultEndpointDataDestroySampleFunction)
            CalculatorReplyPlugin::destroy_data,
            NULL, NULL);

    if(epd != NULL)
    {
        if(endpoint_info->endpointKind == PRES_TYPEPLUGIN_ENDPOINT_WRITER)
        {
            serializedSampleMaxSize = CalculatorReplyPlugin::get_serialized_sample_max_size(
                    epd, RTI_FALSE, RTI_CDR_ENCAPSULATION_ID_CDR_BE, 0);

            PRESTypePluginDefaultEndpointData_setMaxSizeSerializedSample(epd, serializedSampleMaxSize);

            if(PRESTypePluginDefaultEndpointData_createWriterPool(
                        epd,
                        endpoint_info,
                        (PRESTypePluginGetSerializedSampleMaxSizeFunction)
                        CalculatorReplyPlugin::get_serialized_sample_max_size, epd,
                        (PRESTypePluginGetSerializedSampleSizeFunction)
                        CalculatorReplyPlugin::get_serialized_sample_size,
                        epd) == RTI_FALSE)
            {
                PRESTypePluginDefaultEndpointData_delete(epd);
                epd = NULL;
            }
        }
    }

    return epd;    
}

void 
CalculatorReplyPlugin::on_endpoint_detached(
    PRESTypePluginEndpointData endpoint_data)
{  
    //printf("=> CalculatorReplyPlugin::on_endpoint_detached\n");
    PRESTypePluginDefaultEndpointData_delete(endpoint_data);
}

RTIBool 
CalculatorReplyPlugin::copy_sample(
    PRESTypePluginEndpointData endpoint_data,
    CalculatorReply *dst,
    const CalculatorReply *src)
{
    //printf("=> CalculatorReplyPlugin::copy_sample\n");
    CalculatorReplyPlugin::copy_data(dst, src);
    return RTI_TRUE;
}

RTIBool 
CalculatorReplyPlugin::serialize(
    PRESTypePluginEndpointData endpoint_data,
    const CalculatorReply *sample, 
    struct RTICdrStream *stream,    
    RTIBool serialize_encapsulation,
    RTIEncapsulationId encapsulation_id,
    RTIBool serialize_sample, 
    void *endpoint_plugin_qos)
{
    //printf("=> CalculatorReplyPlugin::serialize\n");
    eprosima::fastcdr::FastBuffer buffer(stream->_buffer, stream->_bufferLength);
    eprosima::fastcdr::Cdr scdr(buffer, (eprosima::fastcdr::Cdr::Endianness)stream->_endian, eprosima::fastcdr::Cdr::DDS_CDR);
    scdr.moveAlignmentForward(stream->_relativeBuffer - stream->_buffer);
    scdr.jump(stream->_currentPosition - stream->_buffer);

    if(serialize_encapsulation)
    {
        scdr.changeEndianness((eprosima::fastcdr::Cdr::Endianness)(encapsulation_id & 0x1));
        scdr.serialize_encapsulation();
        scdr.resetAlignment();
    }

    if(serialize_sample)
    {
        try
        {
            scdr << *sample;
        }
        catch(eprosima::rpc::exception::BadParamException ex)
        {
            //printf("ERROR<eprosima::rpc::exception::BadParamException>: %s\n", ex.what());
            return RTI_FALSE;
        }
        catch(eprosima::fastcdr::exception::BadParamException ex)
        {
            //printf("ERROR<eprosima::fastcdr::exception::BadParamException>: %s\n", ex.what());
            return RTI_FALSE;
        }
        catch(eprosima::fastcdr::exception::NotEnoughMemoryException ex)
        {
            //printf("ERROR<eprosima::fastcdr::exception::NotEnoughMemoryException>: %s\n", ex.what());
            return RTI_FALSE;
        }
    }

    stream->_currentPosition = scdr.getCurrentPosition();
    return RTI_TRUE;
}

RTIBool 
CalculatorReplyPlugin::deserialize(
    PRESTypePluginEndpointData endpoint_data,
    CalculatorReply **sample,
    RTIBool * drop_sample,
    struct RTICdrStream *stream,   
    RTIBool deserialize_encapsulation,
    RTIBool deserialize_sample, 
    void *endpoint_plugin_qos)
{
    //printf("=> CalculatorReplyPlugin::deserialize\n");
    CalculatorReply *_sample = *sample;
    eprosima::fastcdr::FastBuffer buffer(stream->_buffer, stream->_bufferLength);
    eprosima::fastcdr::Cdr dcdr(buffer, (eprosima::fastcdr::Cdr::Endianness)stream->_endian, eprosima::fastcdr::Cdr::DDS_CDR);
    dcdr.moveAlignmentForward(stream->_relativeBuffer - stream->_buffer);
    dcdr.jump(stream->_currentPosition - stream->_buffer);

    if(deserialize_encapsulation)
    {
        dcdr.read_encapsulation();
        dcdr.resetAlignment();
    }

    if(deserialize_sample)
    {
        dcdr >> *_sample;
    }

    stream->_currentPosition = dcdr.getCurrentPosition();
    return RTI_TRUE;
}

PRESTypePluginKeyKind 
CalculatorReplyPlugin::get_key_kind(void)
{
    //printf("=> CalculatorReplyPlugin::get_key_kind\n");
    return PRES_TYPEPLUGIN_NO_KEY;
}

DDS_TypeCode* CalculatorReply_unionPlugin::get_typecode()
{
    static bool is_initialized = false;

    static DDS_TypeCode_Member CalculatorReply_union_g_tc_members[2] =
    {
                {
                    (char *)"addition",
                    {
                        0,
                        DDS_BOOLEAN_FALSE,
                        -1,
                        NULL
                    },
                    0,
                    1,
                    1,
                    NULL,
                    DDS_BOOLEAN_FALSE,
                    DDS_PRIVATE_MEMBER,
                    0,
                    NULL
                },
                {
                    (char *)"subtraction",
                    {
                        0,
                        DDS_BOOLEAN_FALSE,
                        -1,
                        NULL
                    },
                    0,
                    1,
                    2,
                    NULL,
                    DDS_BOOLEAN_FALSE,
                    DDS_PRIVATE_MEMBER,
                    0,
                    NULL
                }
    };

    static DDS_TypeCode CalculatorReply_union_g_tc =
    {{
         DDS_TK_UNION,
         DDS_BOOLEAN_FALSE,
         -1,
         (char*)"CalculatorReply_union",
         NULL,
         0,
         0,
         NULL,
         2,
         CalculatorReply_union_g_tc_members,
         DDS_VM_NONE
    }};
    
    if(!is_initialized)
    {
        CalculatorReply_union_g_tc_members[1 - 1]._representation._typeCode = (RTICdrTypeCode*)CalculatorPlugin::additionReplyPlugin::get_typecode();
        CalculatorReply_union_g_tc_members[2 - 1]._representation._typeCode = (RTICdrTypeCode*)CalculatorPlugin::subtractionReplyPlugin::get_typecode();

        CalculatorReply_union_g_tc._data._typeCode = (RTICdrTypeCode*)&DDS_g_tc_long;

        is_initialized = true;
    }

    return &CalculatorReply_union_g_tc;
}

DDS_TypeCode* CalculatorReplyPlugin::get_typecode()
{
    //printf("=> CalculatorReplyPlugin::get_typecode\n");
    static bool is_initialized = false;

    static DDS_TypeCode_Member CalculatorReply_g_tc_members[2] =
    {
        // TODO Add header.
        {
            (char *)"_header",
            {
                0,
                DDS_BOOLEAN_FALSE,
                -1,
                NULL
            },
            0,
            0,
            0,
            NULL,
            DDS_BOOLEAN_FALSE,
            DDS_PRIVATE_MEMBER,
            0,
            NULL
        },
        {
            (char *)"unio",
            {
                0,
                DDS_BOOLEAN_FALSE,
                -1,
                NULL
            },
            0,
            0,
            0,
            NULL,
            DDS_BOOLEAN_FALSE,
            DDS_PRIVATE_MEMBER,
            0,
            NULL
        }
    };

    static DDS_TypeCode CalculatorReply_g_tc =
    {{
         DDS_TK_STRUCT,
         DDS_BOOLEAN_FALSE,
         -1,
         (char*)m_typename,
         NULL,
         0,
         0,
         NULL,
         2,
         CalculatorReply_g_tc_members,
         DDS_VM_NONE
    }};
    
    if(!is_initialized)
    {
        CalculatorReply_g_tc_members[0]._representation._typeCode = (RTICdrTypeCode *)eprosima::rpc::protocol::dds::ReplyHeaderPlugin::get_typecode();
        CalculatorReply_g_tc_members[1]._representation._typeCode = (RTICdrTypeCode *)CalculatorReply_unionPlugin::get_typecode();

        is_initialized = true;
    }

    return &CalculatorReply_g_tc;
}

struct PRESTypePlugin *CalculatorReplyPlugin::new_plugin(void)
{
    //printf("=> CalculatorReplyPlugin::new_plugin\n");
    struct PRESTypePlugin *plugin = NULL;
    const struct PRESTypePluginVersion PLUGIN_VERSION = PRES_TYPE_PLUGIN_VERSION_2_0;

    RTIOsapiHeap_allocateStructure(&plugin, struct PRESTypePlugin);

    if (plugin != NULL)
    {
        plugin->version = PLUGIN_VERSION;

        /* set up parent's function pointers */
        plugin->onParticipantAttached =
            (PRESTypePluginOnParticipantAttachedCallback)
            CalculatorReplyPlugin::on_participant_attached;
        plugin->onParticipantDetached =
            (PRESTypePluginOnParticipantDetachedCallback)
            CalculatorReplyPlugin::on_participant_detached;
        plugin->onEndpointAttached =
            (PRESTypePluginOnEndpointAttachedCallback)
            CalculatorReplyPlugin::on_endpoint_attached;
        plugin->onEndpointDetached =
            (PRESTypePluginOnEndpointDetachedCallback)
            CalculatorReplyPlugin::on_endpoint_detached;

        plugin->copySampleFnc =
            (PRESTypePluginCopySampleFunction)
            CalculatorReplyPlugin::copy_sample;
        plugin->createSampleFnc =
            (PRESTypePluginCreateSampleFunction)
            PRESTypePluginDefaultEndpointData_createSample;
        plugin->destroySampleFnc =
            (PRESTypePluginDestroySampleFunction)
            PRESTypePluginDefaultEndpointData_deleteSample;

        plugin->serializeFnc =
            (PRESTypePluginSerializeFunction)
            CalculatorReplyPlugin::serialize;
        plugin->deserializeFnc =
            (PRESTypePluginDeserializeFunction)
            CalculatorReplyPlugin::deserialize;
        plugin->getSerializedSampleMaxSizeFnc =
            (PRESTypePluginGetSerializedSampleMaxSizeFunction)
            CalculatorReplyPlugin::get_serialized_sample_max_size;
        plugin->getSerializedSampleMinSizeFnc =
            (PRESTypePluginGetSerializedSampleMinSizeFunction)
            CalculatorReplyPlugin::get_serialized_sample_min_size;


        plugin->getSampleFnc =
            (PRESTypePluginGetSampleFunction)
            PRESTypePluginDefaultEndpointData_getSample;

        plugin->returnSampleFnc =
            (PRESTypePluginReturnSampleFunction)
            PRESTypePluginDefaultEndpointData_returnSample;

        plugin->getKeyKindFnc =
            (PRESTypePluginGetKeyKindFunction)
            CalculatorReplyPlugin::get_key_kind;


        /* These functions are only used for keyed types. As this is not a keyed
           type they are all set to NULL
         */
        plugin->serializeKeyFnc = NULL;
        plugin->deserializeKeyFnc = NULL;
        plugin->getKeyFnc = NULL;
        plugin->returnKeyFnc = NULL;
        plugin->instanceToKeyFnc = NULL;
        plugin->keyToInstanceFnc = NULL;
        plugin->getSerializedKeyMaxSizeFnc = NULL;
        plugin->instanceToKeyHashFnc = NULL;
        plugin->serializedSampleToKeyHashFnc = NULL;
        plugin->serializedKeyToKeyHashFnc = NULL;

        plugin->typeCode =  (struct RTICdrTypeCode *)CalculatorReplyPlugin::get_typecode();

        plugin->languageKind = PRES_TYPEPLUGIN_DDS_TYPE; 

        /* Serialized buffer */
        plugin->getBuffer = 
            (PRESTypePluginGetBufferFunction)
            PRESTypePluginDefaultEndpointData_getBuffer;
        plugin->returnBuffer = 
            (PRESTypePluginReturnBufferFunction)
            PRESTypePluginDefaultEndpointData_returnBuffer;
        plugin->getSerializedSampleSizeFnc =
            (PRESTypePluginGetSerializedSampleSizeFunction)
            CalculatorReplyPlugin::get_serialized_sample_size;

        plugin->endpointTypeName = m_typename;

        return plugin;
    }

    return NULL;
}

void
CalculatorReplyPlugin::delete_plugin(struct PRESTypePlugin *plugin)
{
    //printf("=> CalculatorReplyPlugin::delete_plugin\n");
    RTIOsapiHeap_freeStructure(plugin);
}

bool CalculatorReplyPlugin::register_type(DDSDomainParticipant *participant, const char *type_name)
{
    //printf("=> CalculatorReplyPlugin::register_type\n");
    bool returnedValue = false;
    struct PRESTypePlugin *typeDDSPlugin = NULL;
    static DDSTypeSupport *typePlugin = NULL;

    if(participant != NULL)
    {
        typeDDSPlugin = CalculatorReplyPlugin::new_plugin();

        if(typeDDSPlugin != NULL)
        {
            if(typePlugin == NULL)
            {
                typePlugin = new CalculatorReplyPlugin();
            }

            typeDDSPlugin->_userBuffer = (PRESWord*)typePlugin;

            if(DDS_DomainParticipant_register_type(participant->get_c_domain_participantI(), type_name, typeDDSPlugin, NULL) == DDS_RETCODE_OK)
                returnedValue = true;

            CalculatorReplyPlugin::delete_plugin(typeDDSPlugin);
        }
    }

    return returnedValue;
}


DDSDataReader* CalculatorReplyPlugin::create_datareaderI(DDSDataReader* dataReader)
{
    return new CalculatorReplyDataReader(dataReader);
}

DDS_ReturnCode_t CalculatorReplyPlugin::destroy_datareaderI(DDSDataReader* dataReader)
{
    delete (CalculatorReplyDataReader*)dataReader;
    return DDS_RETCODE_OK;
}

DDSDataWriter* CalculatorReplyPlugin::create_datawriterI(DDSDataWriter* dataWriter)
{
    return new CalculatorReplyDataWriter(dataWriter);
}

DDS_ReturnCode_t CalculatorReplyPlugin::destroy_datawriterI(DDSDataWriter* dataWriter)
{
    delete (CalculatorReplyDataWriter*)dataWriter;
    return DDS_RETCODE_OK;
}

