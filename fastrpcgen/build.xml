<?xml version="1.0"?>
<!-- buildrootdir property has to be pased as argument to ant program.-->
<project name="fastrpcgen" default="jar" basedir=".">

	<macrodef name="antlr">
		<attribute name="base" />
		<attribute name="grammar" />
		<sequential>
            <java classname="antlr.Tool" classpath="/usr/share/java/antlr.jar">
				<arg value="-o" />
				<arg value="@{base}" />
				<arg value="@{grammar}" />
			</java>
		</sequential>
	</macrodef>

	<macrodef name="antxr">
		<attribute name="base" />
		<attribute name="grammar" />
		<sequential>
            <java classname="com.javadude.antxr.Tool" classpath="../classes/antxr.jar">
				<arg value="-o" />
				<arg value="@{base}" />
				<arg value="@{grammar}" />
			</java>
		</sequential>
	</macrodef>

	<target name="init">
		<tstamp>
			<format property="src.timestamp" pattern="dd/MM/yyyy" />
			<format property="year" pattern="2009-yyyy" />
		</tstamp>

		<!-- Allow any user specific values to override the defaults -->
		<property file="./build.properties" />
		<property environment="env" />

		<property name="Name" value="${ant.project.name}" />
		<property name="name" value="${ant.project.name}" />
		<property name="copyright" value="${year} Proyectos y Sistema de Mantenimiento S.L" />

		<!-- Filters -->
		<filter token="date" value="${src.timestamp}" />
		<filter token="version" value="${version}" />
		<filter token="copyright" value="${copyright}" />

		<!-- Source related properties -->
		<property name="fastrpc.dir" value="${basedir}" />
		<property name="fastrpc.src.dir" value="${fastrpc.dir}${file.separator}src" />
		<property name="fastrpc.src.java" value="${fastrpc.src.dir}" />
		<property name="fastrpc.grammar.dir" value="${fastrpc.dir}${file.separator}grammars" />
        <property name="idl.dir" value="${basedir}" />
        <property name="idl.src.dir" value="${idl.dir}${file.separator}src" />
		<property name="idl.src.java" value="${idl.src.dir}" />
		<property name="idl.grammar.dir" value="${idl.dir}${file.separator}grammars" />
		<!-- buildrootdir is pased as argument to ant program.-->
        <property name="lib.dir" value="${basedir}${file.separator}..${file.separator}classes${file.separator}" />
		<property name="test.dir" value="${basedir}${file.separator}test${file.separator}simple${file.separator}" />
		<property name="tmp.dir" value="./tmp" />
		<property name="src.excludes" value="" />

		<!-- Build related properties -->
		<property name="build.dir" value="${basedir}${file.separator}build" />
		<property name="build.src" value="${build.dir}${file.separator}src" />
		<property name="build.classes" value="${build.dir}" />
		<property name="build.javadocs" value="${basedir}${file.separator}docs${file.separator}api" />
		<property name="build.fastrpcgen.jar" value="${lib.dir}${file.separator}${name}.jar" />
		<property name="build.rpcddsgen.jar" value="${lib.dir}${file.separator}rpcddsgen.jar" />
		<property name="build.rpcrestgen.jar" value="${lib.dir}${file.separator}rpcrestgen.jar" />

		<path id="build.classpath">
			<fileset dir="${lib.dir}">
				<include name="antxr.jar" />
				<include name="stringtemplate-3.2.1.jar" />
			</fileset>
			<fileset file="/usr/share/java/antlr.jar"/>
		</path>

		<path id="run.classpath">
			<fileset dir="${lib.dir}">
				<include name="*.jar" />
			</fileset>
		</path>

		<property name="dist.basedir" value="${build.dir}" />
		<property name="dist.includes" value="${name}${file.separator}**" />
		<property name="dist.excludes" value="**/prj/**,
            **/dist/**,
             **/test/**,
             **/model/**,
             **/build/**,
             **/.DS_Store" />
		<property name="packages" value="${build.packages}" />
		<property name="library.includes" value="${bundle.includes}" />

	</target>


	<!-- =================================================================== -->
	<!-- Basic build targets                                                 -->
	<!-- =================================================================== -->
	<target name="prepare-sources" depends="init">
		<mkdir dir="${build.dir}" />
	</target>

	<!-- =================================================================== -->
	<!-- Compiles the source code                                            -->
	<!-- =================================================================== -->
	<target name="compile" depends="init, prepare-sources" description="Compiles the sources. (Default)">
		<!-- Echo compilation properties -->
		<echo>Building IDL ANTLR grammars... Some warnings are expected...</echo>
        <antlr base="${idl.src.java}${file.separator}com/eprosima/idl/parser/grammar" grammar="${idl.grammar.dir}${file.separator}idl.g" />
		<echo>Building WADL ANTXR grammars... Some warnings are expected...</echo>
		<antxr base="${fastrpc.src.java}${file.separator}com/eprosima/fastrpc/wadl/grammar" grammar="${fastrpc.grammar.dir}${file.separator}wadl.antxr" />
		<echo>Compiling java code...</echo>
		<mkdir dir="${build.classes}" />
        <javac source="1.6" target="1.6" srcdir="${idl.src.java}:${fastrpc.src.java}" destdir="${build.classes}" encoding="utf-8">
			<classpath refid="build.classpath"/>
		</javac>
        <!--> Copy stringtemplates of fastrpc.<-->
		<copy todir="${build.classes}">
			<fileset dir="${fastrpc.src.dir}" includes="**/*.stg" />
		</copy>
        <!--> Copy platform file.<-->
		<copy todir="${build.classes}">
			<fileset dir="${basedir}${file.separator}..${file.separator}src">
				<include name="platforms" />
			</fileset>
		</copy>
        <!--> Copy version file.<-->
		<copy todir="${build.classes}">
			<fileset dir="${basedir}${file.separator}..${file.separator}include${file.separator}rpcdds">
				<include name="fastrpc_version.h" />
			</fileset>
		</copy>
	</target>

	<!-- =================================================================== -->
	<!-- Creates the jar archive                                             -->
	<!-- =================================================================== -->

	<target name="jar" depends="init,compile" description="Builds the rpcddsgen library (.jar).">
		<jar jarfile="${build.rpcddsgen.jar}" basedir="${build.classes}" manifest="manifest_rpcddsgen">
		</jar>
	</target>

	<!-- =================================================================== -->
	<!-- Install components to be packaged in a RPM file. ant jar had to be executed-->
	<!-- =================================================================== -->
	<target name="install" depends="init" description="Copy necessary data for RPM in the buildrootdir">
        <!-- Copy Jar file -->
        <copy todir="${buildrootdir}${file.separator}usr${file.separator}share${file.separator}java"
            file="${build.rpcddsgen.jar}"/>
        <copy todir="${buildrootdir}${file.separator}usr${file.separator}share${file.separator}java"
		file="${basedir}${file.separator}..${file.separator}classes${file.separator}antxr.jar"/>
        <copy todir="${buildrootdir}${file.separator}usr${file.separator}share${file.separator}java"
		file="${basedir}${file.separator}..${file.separator}classes${file.separator}stringtemplate-3.2.1.jar"/>
	</target>

	<!-- =================================================================== -->
	<!-- Cleans up generated classes                                         -->
	<!-- =================================================================== -->
	<target name="clean-classes" depends="init">
		<delete dir="${build.classes}" />
	</target>
</project>

